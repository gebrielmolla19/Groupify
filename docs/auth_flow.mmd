sequenceDiagram
    participant User
    participant Frontend (React)
    participant Backend (Express)
    participant Database (MongoDB)
    participant Spotify (OAuth Provider)

    Note over User, Spotify: 1. Initiation
    User->>Frontend: Clicks "Login with Spotify"
    Frontend->>Backend: Redirects to /auth/login
    Backend->>Spotify: Redirects to Spotify Authorize URL (with scopes)

    Note over User, Spotify: 2. User Consent
    Spotify->>User: Prompts for permission
    User->>Spotify: Grants permission
    Spotify->>Backend: Redirects to /auth/callback?code=...

    Note over Backend, Spotify: 3. Token Exchange
    Backend->>Spotify: Requests tokens with Authorization Code
    Spotify->>Backend: Returns Access Token & Refresh Token
    Backend->>Spotify: Fetches User Profile
    Spotify->>Backend: Returns User Profile Data

    Note over Backend, Database: 4. User Creation / Update
    Backend->>Database: Find or Create User (by Spotify ID)
    Database-->>Backend: User Document
    Backend->>Backend: Generate JWT (expires in 1d)

    Note over Backend, Frontend: 5. Session Establishment
    Backend->>Frontend: Redirects to /auth/callback?token=JWT
    Frontend->>Frontend: Extracts JWT from URL
    Frontend->>Frontend: Stores JWT in localStorage (via UserContext)
    Frontend->>Backend: GET /auth/me (with Bearer JWT)
    Backend->>Database: Fetch User Details
    Database-->>Backend: User Data
    Backend-->>Frontend: Returns User Data
    Frontend->>User: Redirects to Dashboard
